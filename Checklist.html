<apex:page docType="html-5.0"
    sidebar="false" 
    showheader="false"
    standardStylesheets="false"
    standardController="Checklist_Response__c"
    extensions="ChecklistExtension"
    applyHtmlTag="false"
    applyBodyTag="false"   
    id="todo"
    >
<html ng-app="myApp">        
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1,  minimum-scale=1, maximum-scale=1, user-scalable=no"/>
    <meta name="viewport" content="initial-scale = 1.0, user-scalable = no"/>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.1.5/angular.js"> </script>
    <script language="javascript" src="https://maps.google.com/maps/api/js?sensor=false"></script>
    <!-- <apex:includeScript value="{!URLFOR($Resource.RollCallAssets, 'forceTK/forceTK.js')}"/> -->

    <style type="text/css">
        #map {
            height:400px;
        }
    </style>
</head>    

<body>
    <div ng-controller="PagesController">
        <input class='normal' id='checklist_id' type='hidden' value='{!$CurrentPage.parameters.checklist_id}'/>
        <div id="messages"></div>

        <div id="homePage" ng-controller="homeCtrl" ng-show="homePageActive">
            <div ng-click="goToNewListpage()"> Start a New Checklist </div>
            <div ng-click="goToPendingListpage()">Work on a Pending Checklist</div>
            <div ng-click="goTocompletedListPage()">Look at Completed Checklists</div>
        </div>
        <!-- End of homePage -->

        <div id="completedListPage" ng-controller="CompletedListCtrl" ng-show="completedListPageActive">
            <li ng-repeat="checklist in completedchecklistresponses" ng-click="goToDetailPage(checklist.Id)"> 
                <p> Name: {{checklist.Name}} </p>
                <p> Description: {{checklist.Description__c}} </p>
                <p> Id: {{checklist.Id}} </p>
            </li>
            <!-- <div ng-click="goHome()">Go Home</div> -->
        </div>
        <!-- End of newListPage -->

        <div id="newListPage" ng-controller="NewListCtrl" ng-show="newlistPageActive">
            <li ng-repeat="checklist in checklists | orderBy: 'Name'" ng-click="goToDetailPage(checklist.Id)"> 
                <p> Name: {{checklist.Name}} </p>
                <p> Description: {{checklist.Description__c}} </p>
                <p> Id: {{checklist.Id}} </p>
            </li>
            <!-- <div ng-click="goHome()">Go Home</div> -->
        </div>
        <!-- End of newListPage -->

        <div id="pendingListPage" ng-controller="PendingListCtrl" ng-show="pendinglistPageActive">
            <li ng-repeat="checklist in pendingchecklistresponses" ng-click="goToDetailPage(checklist.Id)"> 
                <p> Name: {{checklist.Name}} </p>
                <p> Description: {{checklist.Description__c}} </p>
                <p> Id: {{checklist.Id}} </p>
            </li>
            <!-- <div ng-click="goHome()">Go Home</div> -->
        </div>
        <!-- End of pendingListPage -->

        <div id="checklistDetailPage" ng-controller="ChecklistCtrl" ng-show="detailPageActive">
            <div id="checklist">
                <ul>
                    <li ng-show="!checklistitems.length">No checklistitems</li>
                    <form ng-submit="submitForm()">
                        <li ng-repeat="checklistitem in checklistitems | orderBy: 'Checklist_Item__r.Order__c'"> 
                            <span ng-switch="checklistitem.Checklist_Item__r.Type__c">
                                <p> Question: {{checklistitem.Checklist_Item__r.Question__c}} </p> 
                                <p> Required: {{checklistitem.Checklist_Item__r.Required__c}} </p> 
                                <p> Type: {{checklistitem.Checklist_Item__r.Type__c}} </p> 
                                <p> Id: {{checklistitem.Checklist_Item__c}} </p> 
                                <p> Checklist Id: {{checklistitem.Checklist_Item__r.Checklist__c}} </p> 
                                <p> Order: {{checklistitem.Checklist_Item__r.Order__c}} </p> 
                                <input id="form_yes/no_{{checklistitem.Checklist_Item__c}}" type="checkbox" ng-switch-when="Yes/No" ng-model="checklistitem.Answer__c" ng-required="{{checklistitem.Checklist_Item__r.Required__c}}"> </input>
                                <input id="form_number_{{checklistitem.Checklist_Item__c}}" type="number" ng-switch-when="Number" ng-model="checklistitem.Answer__c" ng-required="{{checklistitem.Checklist_Item__r.Required__c}}"> </input>
                                <input id="form_text_{{checklistitem.Checklist_Item__c}}" type="text" ng-switch-when="Text" ng-model="checklistitem.Answer__c" ng-required="{{checklistitem.Checklist_Item__r.Required__c}}"> </input>
                                <input id="form_date_{{checklistitem.Checklist_Item__c}}" type="date" ng-switch-when="Date" ng-model="checklistitem.Answer__c" ng-required="{{checklistitem.Checklist_Item__r.Required__c}}"> </input>
                                <input class="input" type="file" id="image" accept="image/*" ng-switch-when="Photo" ng-required="{{checklistitem.Checklist_Item__r.Required__c}}"/>
                                <textarea id="form_longtext_{{checklistitem.Checklist_Item__c}}" ng-switch-when="Long Text" ng-model="checklistitem.Answer__c" ng-required="{{checklistitem.Checklist_Item__r.Required__c}}">Enter response here...</textarea>
                                <!-- Multiple Values from Database -->
                                <input id="form_rating_{{checklistitem.Checklist_Item__c}}" type="range" ng-switch-when="Rating" min="{{checklistitem.Values__c[0]}}" max="{{checklistitem.Values__c[3]}}" ng-model="checklistitem.Answer__c" ng-required="{{checklistitem.Checklist_Item__r.Required__c}}"> </input>
                                <!-- <select ng-model="checklistitem.Values__c" ng-options="type for type in types"></select> -->
                                <select id="form_date_{{checklistitem.Checklist_Item__c}}" ng-switch-when="Picklist" ng-model="checklistitem.Answer__c" ng-required="{{checklistitem.Checklist_Item__r.Required__c}}" ng-options="val for val in {{checklistitem.Values}}"> 
                                </select>
                                <!-- <input id="form_checkbox_{{checklistitem.Checklist_Item__c}}" type="checkbox" value="{{checklistitems.Values__c[0]}}" ng-switch-when="Multi-Select"> </input> -->
                                <!-- <input id="form_checkbox_{{checklistitem.Checklist_Item__c}}" type="checkbox" value="{{checklistitems.Values__c[3]}}" ng-switch-when="Multi-Select"> </input -->
                             </span>
                        </li>
                        <input id="submit_button" type="submit" value="Submit"> </input>
                    </form>
                    <button id="save_button" ng-click="saveResponse()"> Save Response </button>
                </ul>
                <!-- <div ng-click="goHome()">Back to Home</div> -->
                <div id="map" ng-show="mapActive"></div>
            </div>
        </div>
        <!-- End of checklistDetailPage -->

    </div>
</body>

<script>
 /* Angular */
var myApp = angular.module('myApp', []);

myApp.service('userService', function() {

    var checklistitems;
    var pendingchecklistresponses;
    var completedchecklistresponses;
    var checklists;
    var checklist_id;

    var observerCallbacks = [];
    // Register an Observer
    this.registerObserverCallback = function(callback){
        observerCallbacks.push(callback);
    };
    this.notifyObservers = function() {
        angular.forEach(observerCallbacks, function(callback){
            callback();
        });
    };
    this.get_checklist_items = function(checklist_id) {
        var that = this;
        Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ChecklistExtension.checklist_items}',
        checklist_id,
            function(result, event){
                if (event.status) {
                    checklistitems = result;
                    for (var i=0; i<checklistitems.length; i++) {
                        if (checklistitems[i].Checklist_Item__r.Type__c == "Picklist") {
                            var values = checklistitems[i].Checklist_Item__r.Values__c; 
                            checklistitems[i].Checklist_Item__r.Values = values.split(', '); 
                        }
                    }
                    console.log(checklistitems);                            
                    that.notifyObservers();
                } else if (event.type === 'exception') {
                    console.log('Exception: ' + event.message);
                } else {
                    console.log('Error!');
                }
            },
        {escape: true}
        );
    }
    this.get_completed_CLRI = function() {
        var that = this;
        Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ChecklistExtension.completed_checklists}',
            function(result, event){
                if (event.status) {
                    completedchecklistresponses = result;
                    that.notifyObservers();
                } else if (event.type === 'exception') {
                    console.log('Exception: ' + event.message);
                } else {
                    console.log('Error!');
                }
            },
        {escape: true}
        );
    }
    this.get_pending_CLRI = function() {
        var that = this;
        Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ChecklistExtension.pending_checklists}',
            function(result, event){
                if (event.status) {
                    pendingchecklistresponses = result;
                    that.notifyObservers();
                } else if (event.type === 'exception') {
                    console.log('Exception: ' + event.message);
                } else {
                    console.log('Error!');
                }
            },
        {escape: true}
        );
    }
    this.edit_checklist_items = function(checklist_response_id) {
        var that = this;
        Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ChecklistExtension.edit_checklist_items}',
        checklist_response_id,
            function(result, event){
                if (event.status) {
                    if (result.length == 0) return;
                    checklistitems = result;
                    for (var i=0; i<result.length; i++) {
                        if (result[i].Answer__c == "true") { 
                            result[i].Answer__c = true;
                        } else if (result[i].Answer__c == "false") {
                            result[i].Answer__c = false;
                        } else if (!isNaN(result[i].Answer__c)) {
                            result[i].Answer__c = parseInt(result[i].Answer__c);
                        }
                    }
                    that.notifyObservers();
                } else if (event.type === 'exception') {
                    console.log('Exception: ' + event.message);
                } else {
                    console.log('Error!');
                }
            },
        {escape: true}
        );
    }
    this.finish_checklist_response = function(checklist_response_id) {
        var that = this;
        Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ChecklistExtension.finish_checklist_items}',
        checklist_response_id,
            function(result, event){
                if (event.status) {
                    pendingchecklistresponses = result[0];
                    completedchecklistresponses = result[1];
                    that.notifyObservers();
                } else if (event.type === 'exception') {
                    console.log('Exception: ' + event.message);
                } else {
                    console.log('Error!');
                }
            },
        {escape: true}
        );
    }
    this.getCLIs = function () {
        return checklistitems;
    };
    this.getPendingCLRs = function() {
        return pendingchecklistresponses;
    }
    this.getCompletedCLRs = function() {
        return completedchecklistresponses;
    }
})

myApp.controller("homeCtrl", function ($scope, userService) {
});

myApp.controller("CompletedListCtrl", function ($scope, userService) {
    init();
    function init() {
        $scope.pendingchecklistresponses = userService.getPendingCLRs();
        $scope.completedchecklistresponses = userService.getCompletedCLRs();
        userService.registerObserverCallback(updatechecklistresponses);
    }
    function updatechecklistresponses() {
        $scope.pendingchecklistresponses = userService.getPendingCLRs();
        $scope.completedchecklistresponses = userService.getCompletedCLRs();
        // Make sure the scope refreshes itself
        $scope.$apply();
    };
    Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ChecklistExtension.completed_checklists}',
            function(result, event){
                if (event.status) {
                    $scope.checklistitems = result; 
                } else if (event.type === 'exception') {
                    console.log('Exception: ' + event.message);
                } else {
                    console.log('Error!');
                }
            },
        {escape: true}
    );
});

myApp.controller("NewListCtrl", function ($scope, userService) {
    checklists = {!CheckLists};
    $scope.checklists = checklists;
});

myApp.controller("PendingListCtrl", function ($scope, userService) {
    init();
    function init() {
        $scope.pendingchecklistresponses = userService.getPendingCLRs();
        $scope.completedchecklistresponses = userService.getCompletedCLRs();
        userService.registerObserverCallback(updatechecklistresponses);
    }
    function updatechecklistresponses() {
        $scope.pendingchecklistresponses = userService.getPendingCLRs();
        $scope.completedchecklistresponses = userService.getCompletedCLRs();
        // Make sure the scope refreshes itself
        $scope.$apply();
    };
    Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ChecklistExtension.pending_checklists}',
            function(result, event){
                if (event.status) {
                    $scope.checklistitems = result; 
                } else if (event.type === 'exception') {
                    console.log('Exception: ' + event.message);
                } else {
                    console.log('Error!');
                }
            },
        {escape: true}
    );
});

myApp.controller("ChecklistCtrl", function ($scope, userService) {
    init();
    function init() {
        $scope.checklistitems = userService.getCLIs();
        userService.registerObserverCallback(updateChecklistitems);
    }
    function updateChecklistitems() {
        $scope.checklistitems = userService.getCLIs();
        // Make sure the scope refreshes itself
        $scope.$apply();
    };
    $scope.submitForm = function() {
        var that = this;
        var checklist_response;
        for(var i = 0; i < $scope.checklistitems.length; i++) {
            delete $scope.checklistitems[i].$$hashKey;
        }
        delete $scope.checklistitems.attributes;
        /*
        function getUrlVars() {
            var vars = [], hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
            for (var i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        } 
        checklist_response = getUrlVars()['id'];
        if (checklist_response == null) {
            checklist_response = '';
        }
        */
        var checklist_response = $('#checklist_id').val(); 
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.ChecklistExtension.submit_responses}',
            checklist_response,
            $scope.checklistitems,
                function(result, event){
                    if (event.status) {
                        $scope.checklistitems = result; 
                        userService.edit_checklist_items(checklist_response);
                    } else if (event.type === 'exception') {
                        console.log('Exception: ' + event.message);
                    } else {
                        console.log('Error!');
                    }
                },
            {escape: true}
        );
        $("#messages").text('Success!');
    }

    $scope.saveResponse = function() {
        var that = this;
        var checklist_response;
        for(var i = 0; i < $scope.checklistitems.length; i++) {
            delete $scope.checklistitems[i].$$hashKey;
        }
        delete $scope.checklistitems.attributes;
        /*
        function getUrlVars() {
            var vars = [], hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
            for (var i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        } 
        checklist_response = getUrlVars()['id'];
        if (checklist_response == null) {
            checklist_response = '';
        }
        */
        var checklist_response = $('#checklist_id').val(); // works for pending to completed
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.ChecklistExtension.save_responses}',
            checklist_response,
            $scope.checklistitems,
                function(result, event){
                    if (event.status) {
                        $scope.checklistitems = result; 
                        userService.edit_checklist_items(checklist_response);
                    } else if (event.type === 'exception') {
                        console.log('Exception: ' + event.message);
                    } else {
                        console.log('Error!');
                    }
                },
            {escape: true}
        );
        $("#messages").text('Success!');
    }
});

var controllers = {};
controllers.PagesController = function ($scope, userService) {
    /*
    // Get Url Parameters
    function getUrlVars() {
        var vars = [], hash;
        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for (var i = 0; i < hashes.length; i++) {
            hash = hashes[i].split('=');
            vars.push(hash[0]);
            vars[hash[0]] = hash[1];
        }
        return vars;
    }
    var checklist = getUrlVars()['checklist_id']; 
    var response = getUrlVars()['id']; 

    // Specific checklist
    if (checklist != null ) {
        userService.get_checklist_items(checklist);
        $scope.newlistPageActive = false;
        $scope.checklist_id = checklist;
        $scope.mapActive = false;
        $scope.detailPageActive = true;
    }
    // Specific response
    if (response != null ) {
        userService.edit_checklist_items(response);
        $scope.newlistPageActive = false;
        $scope.checklist_id = response;
        $scope.mapActive = true;
        $scope.detailPageActive = true;
    }
    if (checklist == undefined && response == undefined) {
        $scope.detailPageActive = false;
        $scope.checklist_id = null;
        $scope.newlistPageActive = false;
        $scope.homePageActive = true;
    }
    */
    $scope.homePageActive = true;
    $scope.goHome = function() {
        $scope.detailPage = false;   
        $scope.newListpage = false;   
        $scope.pendingListpage = false; 
        $scope.completedListPage = false;
        $scope.newlistPageActive = false;
        $scope.completedListPageActive = false;
        $scope.detailPageActive = false;
        $("#messages").text('');
        $scope.homePageActive = true; 
    };
    $scope.goToDetailPage = function(checklist_id) {
        $("#messages").text('');
        $scope.checklist_id = checklist_id;
        $('#checklist_id').val(checklist_id);
        userService.get_checklist_items(checklist_id);
        $scope.newlistPageActive = false;
        // $scope.homePageActive = false;        
        $scope.pendinglistPageActive = false;           
        $scope.completedListPageActive = false;
        userService.edit_checklist_items(checklist_id);
        $scope.detailPageActive = true;
    };
    $scope.goToNewListpage = function() {
        $("#messages").text('');
        $('#submit_button').show();
        $('#save_button').show();
        $('#checklist_id').val('');
        $scope.detailPageActive = false; 
        $scope.mapActive = false;    
        // $scope.homePageActive = false;    
        $scope.pendinglistPageActive = false;           
        $scope.completedListPageActive = false;
        $scope.newlistPageActive = true;
    };
    $scope.goToPendingListpage = function() {
        $("#messages").text('');
        $('#submit_button').show();
        $('#save_button').show();
        userService.get_pending_CLRI();
        $scope.newlistPageActive = false;
        $scope.detailPageActive = false; 
        $scope.mapActive = false;      
        $scope.newlistPageActive = false;
        // $scope.homePageActive = false;
        $scope.completedListPageActive = false;
        $scope.pendinglistPageActive = true;            
    };
    $scope.goTocompletedListPage = function() {
        $("#messages").text('');
        userService.get_completed_CLRI();
        $scope.newlistPageActive = false;
        $scope.detailPageActive = false; 
        $scope.mapActive = false;    
        $scope.pendinglistPageActive = false;            
        // $scope.homePageActive = false;
        $scope.completedListPageActive = true;
        $('#submit_button').hide();
        $('#save_button').hide();
    };
}

myApp.controller(controllers);

google.maps.event.addDomListener(window, "load", initMap);
function initMap(){
    // Get Url Parameters
    function getUrlVars() {
        var vars = [], hash;
        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for (var i = 0; i < hashes.length; i++) {
            hash = hashes[i].split('=');
            vars.push(hash[0]);
            vars[hash[0]] = hash[1];
        }
        return vars;
    }
    response = getUrlVars()['id'];
    var latlng = new google.maps.LatLng(-34.397, 150.644);
    var myOptions = {
        zoom: 5,
        center: latlng,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    var map = new google.maps.Map(document.getElementById("map"),myOptions);
    /*
    Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ChecklistExtension.lat_long}',
        response,
            function(result, event){
                if (event.status) {
                    console.log('result: ' + result);
                    console.log(result['&quot;Location__c&quot;']);

                    var latlng = new google.maps.LatLng(-34.397, 150.644);
                    var myOptions = {
                        zoom: 5,
                        center: latlng,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    };
                    var map = new google.maps.Map(document.getElementById("map"),myOptions);
                } else if (event.type === 'exception') {
                    console.log('Exception: ' + event.message);
                } else {
                    console.log('Error!');
                }
            },
        {escape: true}
    );
    */
};
</script>
</html>
</apex:page>