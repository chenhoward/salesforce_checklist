<apex:page docType="html-5.0"
sidebar="false" 
showheader="false"
standardStylesheets="false"
standardController="Checklist_Response__c"
extensions="ChecklistExtension"
applyHtmlTag="false"
applyBodyTag="false"
id="todo"
>
<html ng-app="checklistApp">
<head>
  <apex:stylesheet value="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400"/>
  <meta name="viewport" content="width=device-width, initial-scale=1,  minimum-scale=1, maximum-scale=1, user-scalable=no"/>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.1.5/angular.js"> </script>
  <apex:includeScript value="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"/>
  <apex:includeScript value="{!URLFOR($Resource.ChecklistAssets, 'forceTK/forceTK.js')}"/>
  <apex:includeScript value="{!URLFOR($Resource.RollCallAssets, 'fastclick/fastclick.js')}"/>

  <script language="javascript" src="https://maps.google.com/maps/api/js?sensor=false"></script>
  <script>
  Visualforce.remoting.timeout = 120000;
  </script>
  <script type="text/javascript">
  function setSection(to, from)
  {
    if (!(to.hasClass("active")))
    {
      from.animate({"left":"-100%"},100,'linear')
      to.animate({"left":"0%"},100,'linear',function()
      {
        from.css("left","100%");
        from.removeClass("active");
        to.addClass("active");
      });
      if (to.is("#one")) {
        $("#pending-tab").addClass("active-tab");
        $("#pending-alt").css("display", "inline");
        $("#pending").css("display", "none");
      }
      if (from.is("#one")) {
        $("#pending-tab").removeClass("active-tab");
        $("#pending").css("display", "inline");
        $("#pending-alt").css("display", "none");
      }
      if (to.is("#four")) {
        $("#complete-tab").addClass("active-tab");
        $("#complete-alt").css("display", "inline");
        $("#complete").css("display", "none");
      }
      if (from.is("#four")) {
        $("#complete-tab").removeClass("active-tab");
        $("#complete").css("display", "inline");
        $("#complete-alt").css("display", "none");
      }
      $('#new-div').animate({"top":"100%"},100,'linear');
    }
  }
  $(document).ready(function(){
    $('a').on('click', function(event)
    {
      var sectionId = $(this).attr("data-section"),
      $toSlide= $("#container section#"+sectionId),
      $fromSlide= $('.active');
      setSection($toSlide, $fromSlide);
    });
    $('#newbut').on('click', function(event)
    {
      $('#new-div').animate({"top":"0%"},100,'linear');
    });
    $('#hide-new').on('click', function(event)
    {
      $('#new-div').animate({"top":"100%"},100,'linear');
    });
    $('#hide-checklist').on('click', function(event)
    {
      setSection($('#one'), $('#two'));
    });
  });
  </script>
  <title> Checker </title>
  <style type="text/css">
  .repaint { -webkit-animation: bugfix infinite 1s; }

  @-webkit-keyframes bugfix {
    from { fill: 0; }
    to { fill: 0; }
  }

  body {
    font-family: Source Sans Pro, sans-serif;
    font-weight: 300;
    margin: 0px;
    padding: 0px;
    height: 100%;
    overflow: hidden;
    background: #FFF;
  }

  *:focus {
    outline: none;
  }

  p {
    padding: 0px;
    margin: 0px;
  }

  #container {
    position: absolute;
    top: 0px;
    left: 0px;
    right: 0px;
    bottom: 0px;
    overflow: hidden;
    background: transparent;
  }

  #container section {
    position: absolute;
    width: 100%;
    height: 100%;
    left: 100%;
    overflow: scroll;
    background: #fff;
    -webkit-overflow-scrolling: touch;
  }

  #new-div {
    position: fixed;
    z-index: 4;
    width: 100%;
    height: 100%;
    top: 100%;
    overflow: scroll;
    background: #fff;
    -webkit-overflow-scrolling: touch;
  }

  #container section:nth-child(1) {
    left: 0%;
  }

  #one {
    z-index: 2;
  }

  #two, #three, #five {
    z-index: 4;
  }

  .spacer {
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    height: 75px;
    width: 100%;
  }

  #navbar {
    position: fixed;
    z-index: 3;
    width: 100%;
    height: 75px;
    top: 0px;
    left: 0px;
    background: #FFF;
    border-bottom: 1px solid #cccccc;
  }

  .navbut {
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    float: left;
    width: 50%;
    height: 75px;
    color: #999999;
    text-align: center;
    text-decoration: none;
    box-shadow: -1px 0px 0px #cccccc;
    background:  #FFF;
  }

  #new {
    margin-top: 13px;
    width: 30px;
    height: 30px;
  }

  #newtag {
    margin-top: -2px;
  }

  #pending {
    display: none;
    margin-top: 10px;
    width: 30px;
    height: 30px;
  }

  #pending-alt {
    margin-top: 10px;
    width: 30px;
    height: 30px;
  }

  #pendingtag {
    margin-top: -2px;
  }

  #complete {
    margin-top: 5px;
    width: 40px;
    height: 40px;
  }

  #complete-alt {
    display: none;
    margin-top: 5px;
    width: 40px;
    height: 40px;
  }

  #completetag {
    margin-top: -7px;
  }

  #newbut {
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    position: fixed;
    color: #fff;
    text-align: center;
    text-decoration: none;
    z-index: 3;
    width: 100%;
    height: 75px;
    bottom: 0px;
    left: 0px;
    background: #8cd250;
    border-top: 1px solid #cccccc;
  }

  #newbut:hover {
    cursor: pointer;
  }

  .link {
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    display: block;
    color: #4d4d4d;
    text-decoration: none;
    text-align: left;
    font-size: 18px;
    padding: 16px;
    border-bottom: 1px solid #cccccc;
    background: #FFF;
    width: 100%;
  }

  .link:hover {
    cursor: pointer;
  }

  .bi-button-list {
    float: left;
    border-radius-top-left: 7px;
    border-radius-bottom-left: 7px;
    height: 43px;
    width: 50%;
  }

  .bi-button-map {
    float: left;
    border-radius-top-left: 7px;
    border-radius-bottom-left: 7px;
    height: 43px;
    width: 50%;
  }

  .openmap {
    position: fixed;
    z-index: 1;
    opacity: 1;
    bottom: 90px;
    right: 15px;
    width: 50px;
    height: 50px;
    padding: 5px;
    background: url("{!URLFOR($Resource.ChecklistAssets, 'map-alt.svg')}");
    background-size: cover;
    background-color: #8cd250;
  }

  .openmap-active {
    background: url("{!URLFOR($Resource.ChecklistAssets, 'list.svg')}");
    background-size: cover;
    background-color: #8cd250;
  }

  .x {
    position: absolute;
    z-index: 99;
    opacity: 1;
    top: 0px;
    right: 0px;
    width: 20px;
    height: 20px;
    padding: 20px;
  }

  .x-active {
    -webkit-animation-duration: 1s;
    animation-duration: 1s;
    -webkit-animation-delay: 1.5s;
    animation-delay: 1.5s;
    -webkit-animation-fill-mode: both;
    animation-fill-mode: both;
    -webkit-backface-visibility: visible !important;
    -ms-backface-visibility: visible !important;
    backface-visibility: visible !important;
    -webkit-animation-name: flipInY;
    animation-name: flipInY;
  }

  .x:hover {
    cursor: pointer;
  }

  .checklist {
    float: left;
    width: 38px;
    height: 38px;
    margin-right: 16px;
  }

  .map {
    float: left;
    width: 38px;
    height: 38px;
    margin-right: 16px;
    margin-top: 1px;
  }

  .blurb {
    color: #999999;
    margin-top: -2px;
    font-size: 14px;
  }

  .last {
    border-bottom: 1px solid #cccccc;
  }

  .arrow-right {
    float: right;
    margin-top: -25px;
    width: 10px; 
    height: 10px;
    -webkit-transform: rotate(45deg);
    border-top: 3px solid #cccccc;
    border-right: 3px solid #cccccc;
  }

  .title {
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    font-weight: 400;
    display: block;
    color: #FFF;
    text-decoration: none;
    text-align: center;
    font-size: 24px;
    padding: 25px;
    padding-bottom: 24px;
    background: #333333;
    width: 100%;
  }

  .question {
    overflow: auto;
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    display: block;
    color: #4d4d4d;
    text-decoration: none;
    text-align: left;
    font-size: 18px;
    padding: 16px;
    padding-bottom: 24px;
    box-shadow: 0px -1px 0px #cccccc;
    background: #FFF;
    width: 100%;
  }

  input, textarea, select {
    font-family: Source Sans Pro, sans-serif;
    font-weight: 300;
    font-size: 18px;
    color: #4d4d4d;
    width: 80%;
    margin-top: 16px;
    padding: 4px;
    padding-left: 10px;
    outline: none;
    border: 1px solid #999999;
    margin-right: 20%;
    max-width: 800px;
    background: transparent;
    border-radius: 5px;
    -webkit-appearance: none;
  }

  textarea {
    height: 150px;
  }

  select {
    background: url("{!URLFOR($Resource.ChecklistAssets, 'arrow-bottom.png')}") no-repeat right;
    background-size: 60px 60px;
  }

  .magic-div {
    position: relative;
    width: 150px;
    height: 38px;
    margin-top: 15px;
  }

  .camera {
    position: absolute;
    width: 38px;
    height: 38px;
  }

  .camera-blurb {
    position: absolute;
    font-weight: 400;
    color: #999999;
    left: 48px;
    top: 8px;
  }

  .add-photo {
    position: absolute;
    opacity: 0;
    top: -20px;
    width: 125px;
    height: 35px;
  }

  .photo-preview {
    position: absolute;
    left: 125px;
    width: 38px;
    height: 38px;
  }

  .toggle-spacer {
    height: 20px;
    width: 1px;
  }

  .check-spacer {
    height: 16px;
    width: 1px;
  }

  .check-label {
    position: relative;
    top: -10px;
    margin-left: 10px;
  }

  #yes-button {
    font-weight: 400;
    padding: 5px;
    padding-right: 10px;
    padding-left: 10px;
    color: #b3b3b3;
    background: #b3b3b3;
    border: 1px solid #999999;
    padding-right: 5px;
    border-right: none;
    border-top-left-radius: 5px;
    border-bottom-left-radius: 5px;
  }

  #no-button {
    font-weight: 400;
    padding: 5px;
    padding-right: 10px;
    padding-left: 10px;
    color: #FFF;
    background: #f06060;
    border: 1px solid #999999;
    border-top-right-radius: 5px;
    border-bottom-right-radius: 5px;
  }

  .yes-no {
    display: none;
  }

  .yes-no:checked ~ #yes-button {
    color: #FFF;
    background: #8cd250;
  }

  .yes-no:checked ~ #no-button {
    color: #b3b3b3;
    background: #b3b3b3;
  }

  #pass-button {
    font-weight: 400;
    padding: 5px;
    padding-right: 10px;
    padding-left: 10px;
    color: #b3b3b3;
    background: #b3b3b3;
    border: 1px solid #999999;
    padding-right: 5px;
    border-right: none;
    border-top-left-radius: 5px;
    border-bottom-left-radius: 5px;
  }

  #fail-button {
    font-weight: 400;
    padding: 5px;
    padding-right: 10px;
    padding-left: 10px;
    color: #FFF;
    background: #f06060;
    border: 1px solid #999999;
    border-top-right-radius: 5px;
    border-bottom-right-radius: 5px;
  }

  #passfail {
    display: none;
  }

  #passfail:checked ~ #pass-button {
    color: #FFF;
    background: #8cd250;
  }

  #passfail:checked ~ #fail-button {
    color: #b3b3b3;
    background: #b3b3b3;
  }

  input[type="number"] {
    width: 80px;
  }

  input[type="range"] {
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    margin-top: 20px;
    margin-bottom: 0px;
    -webkit-appearance: none;
    background-color: #FFF;
    height: 5px;
    border-radius: 5px;
    border: 1px solid #999999;
  }

  input[type="range"]::-webkit-slider-thumb {
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    -webkit-appearance: none;
    margin-bottom: 0px;
    border-radius: 10px;
    background-color: #FFF;
    border: 1px solid #999999;
    height: 20px;
    width: 20px;
  }

  input[type="date"] {
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    height: 48px;
  }

  input[type="checkbox"] {
    width: 30px;
    height: 30px;
    margin: 0px;
    background: #FFF;
  }

  input[type="checkbox"]:checked {
    background: url("{!URLFOR($Resource.ChecklistAssets, 'check.svg')}") no-repeat center;
    background-size: cover;
    box-shadow: none;
  }

  input[type="radio"] {
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    width: 30px;
    height: 30px;
    border: 5px solid #FFF;
    box-shadow: 0px 0px 0px 2px #999999;
    border-radius: 15px;
    margin: 0px;
    background: #FFF;
  }

  input[type="radio"]:checked {
    background: #8cd250;
    box-shadow: 0px 0px 0px 2px #999999;
  }

  .submit {
    float: left;
    font-family: Source Sans Pro, sans-serif;
    font-weight: 400;
    max-width: 50%;
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    display: block;
    color: #FFF;
    text-decoration: none;
    text-align: center;
    font-size: 24px;
    padding: 25px;
    padding-bottom: 24px;
    border-radius: 0px;
    border: none;
    margin: 0px;
    background: #8cd250;
    width: 100%;
  }

  .save {
    float: left;
    font-family: Source Sans Pro, sans-serif;
    font-weight: 400;
    max-width: 50%;
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    display: block;
    color: #FFF;
    text-decoration: none;
    text-align: center;
    font-size: 24px;
    padding: 25px;
    padding-bottom: 24px;
    border-radius: 0px;
    border: none;
    margin: 0px;
    background: #32aad2;
    width: 50%;
  }

  .form-buttons {
    font-family: Source Sans Pro, sans-serif;
    font-weight: 400;
    max-width: 100%;
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    display: block;
    color: #FFF;
    text-decoration: none;
    text-align: center;
    font-size: 24px;
    padding: 0pc;
    border: none;
    margin: 0px;
    box-shadow: 0px -1px 0px #cccccc;
    background: #8cd250;
    width: 100%;
  }

  #conclusion {
    text-align: center;
  }

  #return {
    font-weight: 400;
    text-align: center;
    color: #FFF;
    width: 100%;
    background: #8cd250;
    font-size: 24px;
    padding: 25px;
    padding-bottom: 24px;
    border: none;
    margin: 0px;
    box-shadow: 0px -1px 0px #cccccc;
  }

  #hide {
    display:none;
  }

  .rating input {
    position: absolute;
    filter: alpha(opacity=0);
    -moz-opacity: 0;
    -khtml-opacity: 0;
    opacity: 0;
    cursor: pointer;
    width: 17px;
  }

  .rating span {
    width: 24px;
    height: 16px;
    line-height: 16px;
    padding: 1px 22px 1px 0; /* 1px FireFox fix */
    background: url(http://goo.gl/SfoCPp) no-repeat -22px 0;
  }

  .rating input:checked + span {
    background-position:-22px 0;
  }

  .rating input:checked + span ~ span {
    background-position:0 0;
  }

  .green_text {
    color: #8cd250;
  }

  .active-tab {
    border-bottom: 7px solid #8cd250;
    color: #8cd250;
  }

  .flipbox {
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
  }

  #back {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #b3b3b3;
  }

  #back iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
  }

  .error-invalid::after{
    display: block;
    color: #f06060;
    padding-top: 10px;
    content: "Invalid or required content";
  }

  .error-border {
    border: 2px solid #f06060;
    border-radius: 7px;
  }

  .animated {
    -webkit-animation-duration: 2s;
    animation-duration: 2s;
    -webkit-animation-fill-mode: both;
    animation-fill-mode: both;
  }

  @-webkit-keyframes flipInY {
    0% {
      -webkit-transform: rotateY(135deg);
      transform: rotateY(135deg);
      opacity: 0;
    }

    100% {
      -webkit-transform: rotateY(0deg);
      transform: rotateY(0deg);
      opacity: 1;
    }
  }

  @keyframes flipInY {
    0% {
      -webkit-transform: rotateY(135deg);
      -ms-transform: rotateY(135deg);
      transform: rotateY(135deg);
      opacity: 0;
    }

    100% {
      -webkit-transform: rotateY(0deg);
      -ms-transform: rotateY(0deg);
      transform: rotateY(0deg);
      opacity: 1;
    }
  }

  .flipInY {
    -webkit-backface-visibility: visible !important;
    -ms-backface-visibility: visible !important;
    backface-visibility: visible !important;
    -webkit-animation-name: flipInY;
    animation-name: flipInY;
  }
  
  @-webkit-keyframes flipOutY {
    0% {
      -webkit-transform: rotateY(0deg);
      transform: rotateY(0deg);
      opacity: 1;
    }

    100% {
      -webkit-transform: rotateY(135deg);
      transform: rotateY(135deg);
      opacity: 0;
    }
  }

  @keyframes flipOutY {
    0% {
      -webkit-transform: rotateY(0deg);
      -ms-transform: rotateY(0deg);
      transform: rotateY(0deg);
      opacity: 1;
    }

    100% {
      -webkit-transform: rotateY(135deg);
      -ms-transform: rotateY(135deg);
      transform: rotateY(135deg);
      opacity: 0;
    }
  }

  .flipOutY {
    -webkit-backface-visibility: visible !important;
    -ms-backface-visibility: visible !important;
    backface-visibility: visible !important;
    -webkit-animation-name: flipOutY;
    animation-name: flipOutY;
  }

  html { height: 100% }

  body { height: 100%; margin: 0; padding: 0 }

  #googleMap { position: fixed; left: 0; top: 0; height: 100%; width: 100%; z-index: 1;}

  </style>
</head>

<body>
  <div id="main-page" ng-controller="PagesController">
    <div id="navbar">
      <!-- Currently no icons -->
      <a class="navbut active-tab" id="pending-tab" data-section="one" href="#">
        <p> <img id="pending" src="{!URLFOR($Resource.ChecklistAssets, 'pending.svg')}"></img> </p>
        <p> <img id="pending-alt" src="{!URLFOR($Resource.ChecklistAssets, 'pending-alt.svg')}"></img> </p>
        <p id="pendingtag"> Pending </p>
      </a>
      <a class="navbut" id="complete-tab" data-section="four" href="#">
        <p> <img id="complete" src="{!URLFOR($Resource.ChecklistAssets, 'completed.svg')}"></img> </p>
        <p> <img id="complete-alt" src="{!URLFOR($Resource.ChecklistAssets, 'completed-alt.svg')}"></img> </p>
        <p id="completetag"> Complete </p>
      </a>
    </div>
    <div id="newbut" href="#">
      <p> <img id="new" src="{!URLFOR($Resource.ChecklistAssets, 'new.svg')}"></img> </p>
      <p id="newtag"> New </p>
    </div>
    <div id="new-div">
      <img class="x" id="hide-new" src="{!URLFOR($Resource.ChecklistAssets, 'x.svg')}"></img>
      <div class="title"> New Checklist </div>
      <a class="link" data-section="two" href="#" ng-repeat="checklist in checklists | orderBy: 'Name'" ng-click="goToCreateDetailPage(checklist)">
        <p> {{checklist.Name}} </p>
        <p class="blurb"> {{checklist.Description__c}} &nbsp; </p>
        <div class="arrow-right"></div>
      </a>
    </div>
    <div id="container">
      <section id="one" class="active">
        <div class="spacer"> </div>
        <a class="link" data-section="two" href="#" ng-repeat="checklist in pendingchecklistresponses" ng-click="goToEditDetailPage(checklist)"> 
          <img class="checklist" src="{!URLFOR($Resource.ChecklistAssets, 'checklist.svg')}"></img>
          <p> {{checklist.Checklist__r.Name}}</p>
          <p class="blurb"> {{checklist.Checklist__r.Description__c}} &nbsp;</p>
          <div class="arrow-right"></div>
        </a>

        <div class="spacer"> </div>
      </section>
      <section id="two">
        <form id="checklistForm" name="checklistForm" class="checklistForm" ng-submit="checklistForm.$valid  && submitForm()">
          <img class="x" id="hide-checklist" src="{!URLFOR($Resource.ChecklistAssets, 'x.svg')}"></img>
          <div class="title"> {{checklistName}}  </div>
          <div class="question" ng-repeat="checklistitem in checklistitems | orderBy: 'Checklist_Item__r.Order__c'">
            <span ng-switch="checklistitem.Checklist_Item__r.Type__c">
              <p> {{checklistitem.Checklist_Item__r.Question__c}} </p>
              <p ng-switch-when="Yes/No" class="toggle-spacer"></p>

              <input class="yes-no" id="form_yes/no_{{checklistitem.Checklist_Item__c}}" type="checkbox" ng-switch-when="Yes/No" ng-model="checklistitem.Answer__c"> </input>
              <label ng-switch-when="Yes/No" class="switch repaint" for="form_yes/no_{{checklistitem.Checklist_Item__c}}" id="yes-button"> Yes </label>
              <label ng-switch-when="Yes/No" class="switch repaint" for="form_yes/no_{{checklistitem.Checklist_Item__c}}" id="no-button"> No </label>
              <input id="form_number_{{checklistitem.Checklist_Item__c}}" type="number" ng-switch-when="Number" ng-model="checklistitem.Answer__c" ng-required="{{checklistitem.Checklist_Item__r.Required__c}}" class="h5-number"> </input>
              <input id="form_text_{{checklistitem.Checklist_Item__c}}" type="text" ng-switch-when="Text" ng-model="checklistitem.Answer__c" ng-required="{{checklistitem.Checklist_Item__r.Required__c}}"> </input>
              <input id="form_date_{{checklistitem.Checklist_Item__c}}" type="date" ng-switch-when="Date" ng-model="checklistitem.Answer__c" ng-required="{{checklistitem.Checklist_Item__r.Required__c}}"> </input>
              <input class="input" type="file" id="image" accept="image/*" ng-switch-when="Photo" ng-required="{{checklistitem.Checklist_Item__r.Required__c}}"/>

              <textarea id="form_longtext_{{checklistitem.Checklist_Item__c}}" ng-switch-when="Long Text" ng-model="checklistitem.Answer__c" ng-required="{{checklistitem.Checklist_Item__r.Required__c}}">Enter response here...</textarea>
              <!-- Multiple Values from Database -->
              <input id="form_rating_{{checklistitem.Checklist_Item__c}}" type="range" ng-switch-when="Rating" min="{{checklistitem.Checklist_Item__r.Values[0]}}" max="{{checklistitem.Checklist_Item__r.Values[1]}}" ng-model="checklistitem.Answer__c" ng-required="{{checklistitem.Checklist_Item__r.Required__c}}"> </input>
              <div ng-show="checklistitem.Checklist_Item__r.Type__c=='Rating'">
                {{checklistitem.Answer__c}}
              </div>
              <select id="form_date_{{checklistitem.Checklist_Item__c}}" ng-switch-when="Picklist" ng-model="checklistitem.Answer__c"    ng-required="{{checklistitem.Checklist_Item__r.Required__c}}" ng-options="val for val in checklistitem.Checklist_Item__r.Values"> 
              </select>
              <div ng-switch-when="Multi-Select">
                <div ng-repeat="val in checklistitem.Checklist_Item__r.Values">
                  <p class="check-spacer"></p>
                  <input type="checkbox" name="{{val}}" ng-model="checklistitem.Checklist_Item__r.Values2[$index]"></input>
                  <label class="check-label" value="{{val}}" > {{val}} </label>
                </div>
              </div>
              <div class="magic-div" ng-show="checklistitem.Checklist_Item__r.Attach_Photo__c">
                <p>
                  <img class="camera" src="{!$Resource.checklist_camera}"></img>
                  <span class="camera-blurb"> + Photo </span>
                </p>
                <div>
                  <img class="photo-preview" id="photoPreview_{{checklistitem.Checklist_Item__c}}" src='{!$Resource.checklist_map}'></img>
                  <input type="file" class="photo add-photo" id="photoFile_{{checklistitem.Checklist_Item__c}}" accept="image/*"></input>
                </div>
              </div>
            </span>
          </div>
          <div class="form-buttons">
            <input class="save last" type="button" name="save" value="Save" ng-click="saveResponse()"></input>
            <input class="submit last" type="submit" name="submit" value="Submit"></input>
          </div>
        </form>
      </section>
      <section id="three">
        <div class="title"> {{checklistName}} </div>
        <div class="question">
          <p id="conclusion"> You've just submitted a review of <span class="green_text"> {{checklistName}} </span>. </p>
        </div>
        <a class="link last" id="return" data-section="one" href="#"> Return </a>
      </section>
      <section id="four">
        <div class="spacer"> </div>
        <!--<div class="link maplink" ng-click="revealMap()">
          <img class="map" src="{!$Resource.checklist_map}"></img>
          <p> View Map </p>
          <p class="blurb"> {{completedchecklistresponses.length}} Completed Checklists </p>
        </div>-->
        <div class="link maplink" ng-repeat="checklist in completedchecklistresponses">
          <img class="checklist" src="{!$Resource.checklist_checklist}"></img>
          <p> {{checklist.Checklist__r.Name}} </p>
          <p class="blurb"> {{checklist.Checklist__r.Description__c}} </p>
        </div>
        <div class="spacer"> </div>
      </section>
      <section id="five">
        <div class="title"> {{checklistName}} </div>
        <div class="question">
          <p id="conclusion"> You've just saved a review of <span class="green_text"> {{checklistName}} </span>. </p>
        </div>
        <a class="link last" id="return" data-section="one" href="#"> Return </a>
      </section>
      <div id="googleMap" ng-show="showMapView"></div>
      <div class="openmap" ng-click="revealMap()"></div>
    </div>
  </div>
</body>
<script>

$(function() {
    FastClick.attach(document.body);
});
/** Set up forceTK. */
var forcetkClient = new forcetk.Client();
forcetkClient.setSessionToken('{!$Api.Session_ID}');

/* Fix text boxes on mobile. */
window.onkeydown = function(e){
  var $focused = $(':focus');
  window.focus();
  $focused.focus();
}

/* Angular */
var checklistApp = angular.module('checklistApp', []);
var photoMap = {};

var controllers = {};
/** The main controller for Checklist. */
controllers.PagesController = function ($scope, $timeout) {
  /** List of all Checklist types. */
  $scope.checklists = {!Checklists};
  /** List of Checklist Items. */
  $scope.checklistitems;
  /** List of Completed Checklist Responses. */
  $scope.completedchecklistresponses;
  /** List of Pending Checklist Responses. */
  $scope.pendingchecklistresponses;
  /** A map between a Checklist Response Item Id and an image. */
  $scope.photoMap = {};
  /** The Id of the current Checklist or Checklist Response being worked on. */
  $scope.currentChecklistId;
  /** The current latitude. */
  $scope.latitude = 0;
  /** The current longitude. */
  $scope.longitude = 0;
  /** Determines if the map should be showing. */
  $scope.showMapView = false;

  /** Reveals the map on the screen. */
  $scope.revealMap = function() {
    var hideMap = function() {
      $scope.showMapView = false;
    }

    if ($scope.showMapView == false) {
      document.getElementById('googleMap').style.display="block";
      $scope.showMapView = true;
      map = new google.maps.Map(document.getElementById("googleMap"),mapProp);
      google.maps.event.trigger(map, 'resize');
      $("#googleMap").removeClass("animated");
      $("#googleMap").removeClass("flipOutY");
      $("#googleMap").addClass("animated");
      $("#googleMap").addClass("flipInY");
      $(".openmap").addClass("openmap-active");
      createMarkers();
    } else {
      $("#googleMap").removeClass("animated");
      $("#googleMap").removeClass("flipInY");
      $("#googleMap").addClass("animated");
      $("#googleMap").addClass("flipOutY");
      $timeout(hideMap, 800);
      $(".openmap").removeClass("openmap-active");
    }
  }

  /** Returns all the pending Checklist Responses. */
  var getPendingChecklistResponses = function() {
    Visualforce.remoting.Manager.invokeAction(
      '{!$RemoteAction.ChecklistExtension.pendingChecklists}',
      function(result, event){
        if (event.status) {
          $scope.pendingchecklistresponses = result;
          $scope.$apply();
        } else if (event.type === 'exception') {
          console.log('Exception: ' + event.message);
        } else {
          console.log('Error!');
        }
      },
      {escape: true}
    );
  }

  /** Returns all the complete Checklist Responses. */
  var getCompletedChecklistResponses = function() {
    Visualforce.remoting.Manager.invokeAction(
      '{!$RemoteAction.ChecklistExtension.completedChecklists}',
      function(result, event){
        if (event.status) {
          $scope.completedchecklistresponses = result;
          $scope.$apply();
        } else if (event.type === 'exception') {
          console.log('Exception: ' + event.message);
        } else {
          console.log('Error!');
        }
      },
      {escape: true}
    );
  }

  /* Initiate the list of pending and complete Checklist Responses. */
  getPendingChecklistResponses();
  getCompletedChecklistResponses();

  /** Splits the Checklist Item's possible values if they are a certain type and returns the type. */
  var valueSplitter = function(i) {
    var type = $scope.checklistitems[i].Checklist_Item__r.Type__c;
    if (type == "Picklist" || type == "Rating" || type == "Multi-Select") {
      var values = $scope.checklistitems[i].Checklist_Item__r.Values__c;
      if (values) {
        $scope.checklistitems[i].Checklist_Item__r.Values = values.split(', ');
        $scope.checklistitems[i].Checklist_Item__r.Values2 = [];
      }
    }
    return type;
  }

  /** Sets up Checklist Items to edit a pending Checklist. */
  var editChecklistItems = function() {
    getLocation();
    Visualforce.remoting.Manager.invokeAction(
      '{!$RemoteAction.ChecklistExtension.editChecklistItems}',
      $scope.currentChecklistId,
      function(result, event) {
        if (event.status) {
          if (result.length == 0) return;
          $scope.checklistitems = result;
          for (var i = 0; i < result.length; i++) {
            var type = valueSplitter(i);
            if (type == "Multi-Select") {
              if ($scope.checklistitems[i].Answer__c) {
                var ansArr = $scope.checklistitems[i].Answer__c.split(',');
                var boolArr = [];
                for (var j = 0; j < $scope.checklistitems[i].Checklist_Item__r.Values.length; j++) {
                  if (ansArr.indexOf($scope.checklistitems[i].Checklist_Item__r.Values[j]) > -1) {
                    boolArr[j] = true;
                  } else {
                    boolArr[j] = false;
                  }
                }
                $scope.checklistitems[i].Checklist_Item__r.Values2 = boolArr;
              }
            }
            if ($scope.checklistitems[i].Answer__c == "true") { 
              $scope.checklistitems[i].Answer__c = true;
            } else if ($scope.checklistitems[i].Answer__c == "false") {
              $scope.checklistitems[i].Answer__c = false;
            } else if (!isNaN($scope.checklistitems[i].Answer__c)) {
              $scope.checklistitems[i].Answer__c = parseInt($scope.checklistitems[i].Answer__c);
            }
          }
          $scope.$apply();
        } else if (event.type === 'exception') {
          console.log('Exception: ' + event.message);
        } else {
          console.log('Error!');
        }
      },
      {escape: true}
    );
  }

  /** Gets Checklist Items to create a new Checklist Response. */
  var getChecklistItems = function() {
    getLocation();
    Visualforce.remoting.Manager.invokeAction(
      '{!$RemoteAction.ChecklistExtension.getAllChecklistItems}',
      $scope.currentChecklistId,
      function(result, event){
        if (event.status) {
          $scope.checklistitems = result;
          for (var i = 0; i < $scope.checklistitems.length; i++) {
            valueSplitter(i);
          }
          $scope.$apply();
        } else if (event.type === 'exception') {
          console.log('Exception: ' + event.message);
        } else {
          console.log('Error!');
        }
      },
      {escape: true}
    );
  }

  /** Removes attributes from Checklist Items to allow it to be inserted into or updated in the database. */
  function formHelper() {
    for(var i = 0; i < $scope.checklistitems.length; i++) {
      delete $scope.checklistitems[i].$$hashKey;
      var type = $scope.checklistitems[i].Checklist_Item__r.Type__c;
      if (type == "Multi-Select") {
        if ($scope.checklistitems[i].Checklist_Item__r.Values2.length != 0) {
          var answer = [];
          for (var j = 0; j < $scope.checklistitems[i].Checklist_Item__r.Values.length; j++) {
            if ($scope.checklistitems[i].Checklist_Item__r.Values2[j]) {
              answer.push($scope.checklistitems[i].Checklist_Item__r.Values[j]);
            }
          }
          $scope.checklistitems[i].Answer__c = answer.join();
          $scope.checklistitems[i].Checklist_Item__r.Values2;
        }
      }
      if (type == "Picklist" || type == "Rating" || type == "Multi-Select") {
        delete $scope.checklistitems[i].Checklist_Item__r.Values;
        delete $scope.checklistitems[i].Checklist_Item__r.Values2;
      }
      if ($scope.checklistitems[i].Answer__c) {
        $scope.checklistitems[i].Answer__c = escapeHtml($scope.checklistitems[i].Answer__c);

      }
    }
    delete $scope.checklistitems.attributes;
  }


  /** Creates photoes to attatch to the Checklist Response with id RESPONSEID. */
  function photoHelper(responseId) {
    if (Object.keys($scope.photoMap).length > 0) {
      for (var key in $scope.photoMap) {
        var queryString = "SELECT Id FROM Checklist_Item_Response__c WHERE Checklist_Item__c = '" + key + "' AND Checklist_Response__c = '" + responseId + "'";
        forcetkClient.query(queryString, function(response) {
          forcetkClient.create('Attachment', {'Body' : $scope.photoMap[key], 'ParentId': response.records[0].Id, 'Name' : 'PhotoResponse'});
        });
      }
    }
  }

  /** Completes the current Checklist Response. */
  $scope.submitForm = function() {
    formHelper();
    Visualforce.remoting.Manager.invokeAction(
      '{!$RemoteAction.ChecklistExtension.submitResponses}',
      $scope.currentChecklistId,
      $scope.checklistitems,
      $scope.latitude,
      $scope.longitude,
      function(result, event){
        if (event.status) {
          photoHelper(result);
        } else if (event.type === 'exception') {
          console.log('Exception: ' + event.message);
        } else {
          console.log('Error!');
        }
      },
      {escape: true}
      );
    getPendingChecklistResponses();
    getCompletedChecklistResponses();
    setSection($('#container section#three'), $('.active'));
  }

  /** Saves the current Checklist Response as a pending response. */
  $scope.saveResponse = function() {
    var that = this;
    formHelper();
    Visualforce.remoting.Manager.invokeAction(
      '{!$RemoteAction.ChecklistExtension.saveResponses}',
      $scope.currentChecklistId,
      $scope.checklistitems,
      function(result, event){
        if (event.status) {
          photoHelper(result);
          getLocation();
        } else if (event.type === 'exception') {
          console.log('Exception: ' + event.message);
        } else {
          console.log('Error!');
        }
      },
      {escape: true}
    );
    getPendingChecklistResponses();
    setSection($('#container section#five'), $('.active'));
  }

  /** Sets up Images and updates which Checklist Response that is currently being worked on. */
  function setupDetail(checklist_id) {
    setTimeout(function(){
      setupPhoto();
    },2000);
    $scope.currentChecklistId = checklist_id;
  }

  /** Sets up the page for creating a Checklist Response for CHECKLIST. */
  $scope.goToCreateDetailPage = function(checklist) {
    $scope.checklistName = checklist.Name;
    setupDetail(checklist.Id);
    getChecklistItems();
  }

  /** Sets up the page for updating a Checklist Response CHECKLIST. */
  $scope.goToEditDetailPage = function(checklistResponse) {
    $scope.checklistName = checklistResponse.Checklist__r.Name;
    setSection($('#two'), $('#one'));
    setupDetail(checklistResponse.Id);
    editChecklistItems();
  }

  /** Attatches an event handler to every photo input. */
  var setupPhoto = function(){
    $(".photo").each(function(key,value) {
      $("#" + value.id).change(handlePhoto);
    })
  }

  /** When the EVT occurs, the image is stored into the photoMAP as a base64 string. */
  function handlePhoto(evt){
    var file = evt.target.files[0];
    // replace above with actual file
    var reader = new FileReader();
    reader.onload = (function(theFile) {
      return function(e) {
        // Extract raw base64 data from data URL
        $(evt.target.id).attr('src',e.target.result);
        imageData = e.target.result.split(',')[1];
        var id = evt.target.id.substring(evt.target.id.length-18, evt.target.id.length);
        $("#photoPreview_" + id).attr("src", "data:image/png;base64," + imageData);
        $scope.photoMap[id] = imageData;
      };
    })(file);
    reader.readAsDataURL(file);
  }

  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(showPosition, showError);
    } else {
      alert("No locaiton");
    }
  }
  function showPosition(position) {
    $scope.latitude = position.coords.latitude;
    $scope.longitude = position.coords.longitude; 
  }

  function showError(error) {
    switch(error.code) {
      case error.PERMISSION_DENIED:
      alert("Please turn on locations in S1.")
      break;
      case error.POSITION_UNAVAILABLE:
      alert("Location information is unavailable.")
      break;
      case error.TIMEOUT:
      alert("The request to get user location timed out.")
      break;
      case error.UNKNOWN_ERROR:
      alert("An unknown error occurred.")
      break;
    }
  }

  var mapProp = {
    center:new google.maps.LatLng(51.508742,-0.120850),
    zoom:15,
    mapTypeId:google.maps.MapTypeId.ROADMAP
  }

  var map;

  var markers = [];

  var createMarkers = function() {
    var response;
    clearMarkers();
    boundary = new google.maps.LatLngBounds();
    for (var i = 0; i < $scope.completedchecklistresponses.length; i++) {
      response = $scope.completedchecklistresponses[i];
      var coordinates = new google.maps.LatLng(response.Location__Latitude__s, response.Location__Longitude__s);
      var marker = new google.maps.Marker({
        position: coordinates,
        title: response.Checklist__r.Name
      });
      markers.push(marker);
      boundary.extend(marker.position);
      marker.setMap(map);
    }
    map.fitBounds(boundary)
  }

  var clearMarkers = function() {
    for (var i = markers.length - 1; i >= 0; i--) {
      markers[i].setMap(null);
      markers.pop();
    }
  }
}

checklistApp.controller(controllers);

var entityMap = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': '&quot;',
          "/": '&#x2F;'
        };

function escapeHtml(string) {
  return String(string).replace(/[&<>"\/]/g, function (s) {
    return entityMap[s];
  });
}
</script>
<script>
/**
 * h5Validate
 * @version v0.9.0
 * Using semantic versioning: http://semver.org/
 * @author Eric Hamilton http://ericleads.com/
 * @copyright 2010 - 2012 Eric Hamilton
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 *
 * Developed under the sponsorship of RootMusic, Zumba Fitness, LLC, and Rese Property Management
 */

 /*global jQuery, window, console */
 (function ($) {
  'use strict';
  var console = window.console || function () {},
    h5 = { // Public API
      defaults : {
        debug: false,

        RODom: false,

        // HTML5-compatible validation pattern library that can be extended and/or overriden.
        patternLibrary : { //** TODO: Test the new regex patterns. Should I apply these to the new input types?
          // **TODO: password
          phone: /([\+][0-9]{1,3}([ \.\-])?)?([\(][0-9]{1,6}[\)])?([0-9A-Za-z \.\-]{1,32})(([A-Za-z \:]{1,11})?[0-9]{1,4}?)/,

          // Shamelessly lifted from Scott Gonzalez via the Bassistance Validation plugin http://projects.scottsplayground.com/email_address_validation/
          email: /((([a-zA-Z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-zA-Z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?/,

          // Shamelessly lifted from Scott Gonzalez via the Bassistance Validation plugin http://projects.scottsplayground.com/iri/
          url: /(https?|ftp):\/\/(((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?/,

          // Number, including positive, negative, and floating decimal. Credit: bassistance
          number: /-?(?:\d+|\d{1,3}(?:,\d{3})+)?(?:\.\d+)?/,

          // Date in ISO format. Credit: bassistance
          dateISO: /\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}/,

          alpha: /[a-zA-Z]+/,
          alphaNumeric: /\w+/,
          integer: /-?\d+/
        },

        // The prefix to use for dynamically-created class names.
        classPrefix: 'h5-',

        errorClass: 'ui-state-error', // No prefix for these.
        validClass: 'ui-state-valid', // "
        activeClass: 'active', // Prefix will get prepended.
        requiredClass: 'required',
        requiredAttribute: 'required',
        patternAttribute: 'pattern',

        // Attribute which stores the ID of the error container element (without the hash).
        errorAttribute: 'data-h5-errorid',

        // Events API
        customEvents: {
          'validate': true
        },

        // Setup KB event delegation.
        kbSelectors: ':input:not(:button):not(:disabled):not(.novalidate)',
        focusout: true,
        focusin: false,
        change: true,
        keyup: false,
        activeKeyup: true,

        // Setup mouse event delegation.
        mSelectors: '[type="range"]:not(:disabled):not(.novalidate), :radio:not(:disabled):not(.novalidate), :checkbox:not(:disabled):not(.novalidate), select:not(:disabled):not(.novalidate), option:not(:disabled):not(.novalidate)',
        click: true,

        // What do we name the required .data variable?
        requiredVar: 'h5-required',

        // What do we name the pattern .data variable?
        patternVar: 'h5-pattern',
        stripMarkup: true,

        // Run submit related checks and prevent form submission if any fields are invalid?
        submit: true,

        // Move focus to the first invalid field on submit?
        focusFirstInvalidElementOnSubmit: true,

        // When submitting, validate elements that haven't been validated yet?
        validateOnSubmit: true,

        // Callback stubs
        invalidCallback: function () {},
        validCallback: function () {},

        // Elements to validate with allValid (only validating visible elements)
        allValidSelectors: ':input:visible:not(:button):not(:disabled):not(.novalidate)',

        // Mark field invalid.
        // ** TODO: Highlight labels
        // ** TODO: Implement setCustomValidity as per the spec:
        // http://www.whatwg.org/specs/web-apps/current-work/multipage/association-of-controls-and-forms.html#dom-cva-setcustomvalidity
        markInvalid: function markInvalid(options) {
          var $element = $(options.element),
          $errorID = $(options.errorID);
          $element.addClass(options.errorClass).removeClass(options.validClass);
          $element.prev().addClass('error-invalid');

          // User needs help. Enable active validation.
          $element.addClass(options.settings.activeClass);

          if ($errorID.length) { // These ifs are technically not needed, but improve server-side performance 
            if ($element.attr('title')) {
              $errorID.text($element.attr('title'));
            }
            $errorID.show();
          }
          $element.data('valid', false);
          options.settings.invalidCallback.call(options.element, options.validity);
          return $element;
        },

        // Mark field valid.
        markValid: function markValid(options) {
          var $element = $(options.element),
          $errorID = $(options.errorID);

          $element.addClass(options.validClass).removeClass(options.errorClass);
          $element.prev().removeClass('error-invalid');

          if ($errorID.length) {
            $errorID.hide();
          }
          $element.data('valid', true);
          options.settings.validCallback.call(options.element, options.validity);
          return $element;
        },

        // Unmark field
        unmark: function unmark(options) {
          var $element = $(options.element);
          $element.removeClass(options.errorClass).removeClass(options.validClass);
          $element.form.find("#" + options.element.id).removeClass(options.errorClass).removeClass(options.validClass);
          return $element;
        }
      }
    },

    // Aliases
    defaults = h5.defaults,
    patternLibrary = defaults.patternLibrary,

    createValidity = function createValidity(validity) {
      return $.extend({
        customError: validity.customError || false,
        patternMismatch: validity.patternMismatch || false,
        rangeOverflow: validity.rangeOverflow || false,
        rangeUnderflow: validity.rangeUnderflow || false,
        stepMismatch: validity.stepMismatch || false,
        tooLong: validity.tooLong || false,
        typeMismatch: validity.typeMismatch || false,
        valid: validity.valid || true,
        valueMissing: validity.valueMissing || false
      }, validity);
    },

    methods = {
      /**
       * Check the validity of the current field
       * @param  {object}  settings   instance settings
       * @param  {object}  options
       *      .revalidate - trigger validation function first?
       * @return {Boolean}
       */
       isValid: function (settings, options) {
        var $this = $(this);

        options = (settings && options) || {};

        // Revalidate defaults to true
        if (options.revalidate !== false) {
          $this.trigger('validate');
        }

        return $this.data('valid'); // get the validation result
      },
      allValid: function (config, options) {
        var valid = true,
        formValidity = [],
        $this = $(this),
        $allFields,
        $filteredFields,
        radioNames = [],
        getValidity = function getValidity(e, data) {
          data.e = e;
          formValidity.push(data);
        },
          settings = $.extend({}, config, options); // allow options to override settings

          options = options || {};

          $this.trigger('formValidate', {settings: $.extend(true, {}, settings)});

        // Make sure we're not triggering handlers more than we need to.
        $this.undelegate(settings.allValidSelectors,
          '.allValid', getValidity);
        $this.delegate(settings.allValidSelectors,
          'validated.allValid', getValidity);

        $allFields = $this.find(settings.allValidSelectors);

        // Filter radio buttons with the same name and keep only one,
        // since they will be checked as a group by isValid()
        $filteredFields = $allFields.filter(function(index) {
          var name;

          if(this.tagName === "INPUT"
            && this.type === "radio") {
            name = this.name;
          if(radioNames[name] === true) {
            return false;
          }
          radioNames[name] = true;
        }
        return true;
      });

        $filteredFields.each(function () {
          var $this = $(this);
          valid = $this.h5Validate('isValid', options) && valid;
        });

        $this.trigger('formValidated', {valid: valid, elements: formValidity});
        return valid;
      },
      validate: function (settings) {
        // Get the HTML5 pattern attribute if it exists.
        // ** TODO: If a pattern class exists, grab the pattern from the patternLibrary, but the pattern attrib should override that value.
        var $this = $(this),
        pattern = $this.filter('[pattern]')[0] ? $this.attr('pattern') : false,

          // The pattern attribute must match the whole value, not just a subset:
          // "...as if it implied a ^(?: at the start of the pattern and a )$ at the end."
          re = new RegExp('^(?:' + pattern + ')$'),
          $radiosWithSameName = null,
          value = ($this.is('[type=checkbox]')) ?
          $this.is(':checked') : ($this.is('[type=radio]') ?
                // Cache all radio buttons (in the same form) with the same name as this one
                ($radiosWithSameName = $this.parents('form')
                  // **TODO: escape the radio buttons' name before using it in the jQuery selector
                  .find('input[name="' + $this.attr('name') + '"]'))
                .filter(':checked')
                .length > 0 : $this.val()),
          errorClass = settings.errorClass,
          validClass = settings.validClass,
          errorIDbare = $this.attr(settings.errorAttribute) || false, // Get the ID of the error element.
          errorID = errorIDbare ? '#' + errorIDbare.replace(/(:|\.|\[|\])/g,'\\$1') : false, // Add the hash for convenience. This is done in two steps to avoid two attribute lookups.
          required = false,
          validity = createValidity({element: this, valid: true}),
          $checkRequired = $('<input required>'),
          maxlength;

        /*  If the required attribute exists, set it required to true, unless it's set 'false'.
        * This is a minor deviation from the spec, but it seems some browsers have falsey 
        * required values if the attribute is empty (should be true). The more conformant 
        * version of this failed sanity checking in the browser environment.
        * This plugin is meant to be practical, not ideologically married to the spec.
        */
        // Feature fork
        if ($checkRequired.filter('[required]') && $checkRequired.filter('[required]').length) {
          required = ($this.filter('[required]').length && $this.attr('required') !== 'false');
        } else {
          required = ($this.attr('required') !== undefined);
        }

        if (settings.debug && window.console) {
          console.log('Validate called on "' + value + '" with regex "' + re + '". Required: ' + required); // **DEBUG
          console.log('Regex test: ' + re.test(value) + ', Pattern: ' + pattern); // **DEBUG
        }

        maxlength = parseInt($this.attr('maxlength'), 10);
        if (!isNaN(maxlength) && value.length > maxlength) {
          validity.valid = false; 
          validity.tooLong = true;
        }

        if (required && !value) {
          validity.valid = false;
          validity.valueMissing = true;
        } else if (pattern && !re.test(value) && value) {
          validity.valid = false;
          validity.patternMismatch = true;
        } else {
          if (!settings.RODom) {
            settings.markValid({
              element: this,
              validity: validity,
              errorClass: errorClass,
              validClass: validClass,
              errorID: errorID,
              settings: settings
            });
          }
        }

        if (!validity.valid) {
          if (!settings.RODom) {
            settings.markInvalid({
              element: this,
              validity: validity,
              errorClass: errorClass,
              validClass: validClass,
              errorID: errorID,
              settings: settings
            });
          }
        }
        $this.trigger('validated', validity);

        // If it's a radio button, also validate the other radio buttons with the same name
        // (while making sure the call is not recursive)
        if($radiosWithSameName !== null
          && settings.alreadyCheckingRelatedRadioButtons !== true) {

          settings.alreadyCheckingRelatedRadioButtons = true;

        $radiosWithSameName
        .not($this)
        .trigger('validate');

        settings.alreadyCheckingRelatedRadioButtons = false;

      }
    },

      /**
       * Take the event preferences and delegate the events to selected
       * objects.
       * 
       * @param {object} eventFlags The object containing event flags.
       * 
       * @returns {element} The passed element (for method chaining).
       */
      delegateEvents: function (selectors, eventFlags, element, settings) {
        var events = {},
        key = 0,
        validate = function () {
          settings.validate.call(this, settings);
        };
        $.each(eventFlags, function (key, value) {
          if (value) {
            events[key] = key;
          }
        });
        // key = 0;
        for (key in events) {
          if (events.hasOwnProperty(key)) {
            $(element).delegate(selectors, events[key] + '.h5Validate', validate);
          }
        }
        return element;
      },
      /**
       * Prepare for event delegation.
       * 
       * @param {object} settings The full plugin state, including
       * options. 
       * 
       * @returns {object} jQuery object for chaining.
       */
      bindDelegation: function (settings) {
        var $this = $(this),
        $forms;
        // Attach patterns from the library to elements.
        // **TODO: pattern / validation method matching should
        // take place inside the validate action.
        $.each(patternLibrary, function (key, value) {
          var pattern = value.toString();
          pattern = pattern.substring(1, pattern.length - 1);
          $('.' + settings.classPrefix + key).attr('pattern', pattern);
        });

        $forms = $this.filter('form')
        .add($this.find('form'))
        .add($this.parents('form'));

        $forms
        .attr('novalidate', 'novalidate')
        .submit(checkValidityOnSubmitHandler);

        $forms.find("input[formnovalidate][type='submit']").click(function(){
          $(this).closest("form").unbind('submit', checkValidityOnSubmitHandler);
        });

        return this.each(function () {
          var kbEvents = {
            focusout: settings.focusout,
            focusin: settings.focusin,
            change: settings.change,
            keyup: settings.keyup
          },
          mEvents = {
            click: settings.click
          },
          activeEvents = {
            keyup: settings.activeKeyup
          };

          settings.delegateEvents(':input', settings.customEvents, this, settings);
          settings.delegateEvents(settings.kbSelectors, kbEvents, this, settings);
          settings.delegateEvents(settings.mSelectors, mEvents, this, settings);
          settings.delegateEvents(settings.activeClassSelector, activeEvents, this, settings);
          settings.delegateEvents('textarea[maxlength]', {keyup: true}, this, settings);
        });
      }
    },

    /**
     * Event handler for the form submit event.
     * When settings.submit is enabled:
     *  - prevents submission if any invalid fields are found.
     *  - Optionally validates all fields.
     *  - Optionally moves focus to the first invalid field.
     * 
     * @param {object} evt The jQuery Event object as from the submit event. 
     * 
     * @returns {object} undefined if no validation was done, true if validation passed, false if validation didn't.
     */
    checkValidityOnSubmitHandler = function(evt) {

      var $this,
      settings = getInstance.call(this),
      allValid;

      if(settings.submit !== true) {
        return;
      }

      $this = $(this);
      allValid = $this.h5Validate('allValid', { revalidate: settings.validateOnSubmit === true });

      if(allValid !== true) {
        evt.preventDefault();

        if(settings.focusFirstInvalidElementOnSubmit === true){
          var $invalid = $(settings.allValidSelectors, $this)
          .filter(function(index){
            return $(this).h5Validate('isValid', { revalidate: false }) !== true;
          });

          $invalid.first().focus();
        }
      }

      return allValid;
    },

    instances = [],

    buildSettings = function buildSettings(options) {
      // Combine defaults and options to get current settings.
      var settings = $.extend({}, defaults, options, methods),
      activeClass = settings.classPrefix + settings.activeClass;

      return $.extend(settings, {
        activeClass: activeClass,
        activeClassSelector: '.' + activeClass,
        requiredClass: settings.classPrefix + settings.requiredClass,
        el: this
      });
    },

    getInstance = function getInstance() {
      var $parent = $(this).closest('[data-h5-instanceId]');
      return instances[$parent.attr('data-h5-instanceId')];
    },

    setInstance = function setInstance(settings) {
      var instanceId = instances.push(settings) - 1;
      if (settings.RODom !== true) {
        $(this).attr('data-h5-instanceId', instanceId);
      }
      $(this).trigger('instance', { 'data-h5-instanceId': instanceId });
    };

    $.h5Validate = {
    /**
     * Take a map of pattern names and HTML5-compatible regular
     * expressions, and add them to the patternLibrary. Patterns in
     * the library are automatically assigned to HTML element pattern
     * attributes for validation.
     * 
     * @param {Object} patterns A map of pattern names and HTML5 compatible
     * regular expressions.
     * 
     * @returns {Object} patternLibrary The modified pattern library
     */
    addPatterns: function (patterns) {
      var patternLibrary = defaults.patternLibrary,
      key;
      for (key in patterns) {
        if (patterns.hasOwnProperty(key)) {
          patternLibrary[key] = patterns[key];
        }
      }
      return patternLibrary;
    },
    /**
     * Take a valid jQuery selector, and a list of valid values to
     * validate against.
     * If the user input isn't in the list, validation fails.
     * 
     * @param {String} selector Any valid jQuery selector.
     *
     * @param {Array} values A list of valid values to validate selected 
     * fields against.
     */
    validValues: function (selector, values) {
      var i = 0,
      ln = values.length,
      pattern = '',
      re;
      // Build regex pattern
      for (i = 0; i < ln; i += 1) {
        pattern = pattern ? pattern + '|' + values[i] : values[i];
      }
      re = new RegExp('^(?:' + pattern + ')$');
      $(selector).data('regex', re);
    }
  };

  $.fn.h5Validate = function h5Validate(options) {
    var action,
    args,
    settings;

    if (typeof options === 'string' && typeof methods[options] === 'function') {
      // Whoah, hold on there! First we need to get the instance:
      settings = getInstance.call(this);

      args = [].slice.call(arguments, 0);
      action = options;
      args.shift();
      args = $.merge([settings], args);

      // Use settings here so we can plug methods into the instance dynamically?
      return settings[action].apply(this, args);
    }

    settings = buildSettings.call(this, options);
    setInstance.call(this, settings);

    // Returning the jQuery object allows for method chaining.
    return methods.bindDelegation.call(this, settings);
  };
}(jQuery));
</script>

<script>
$(document).ready(function () {
  $('#checklistForm').h5Validate({
    errorClass:'error-border'
  });
  $('form').h5Validate();
});
</script>

</html>
</apex:page>
